name: Proxmox VE KotH Deployment Checks

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: write

jobs:
    run-tests:
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        runs-on: ubuntu-latest
        steps:
            -
                uses: actions/checkout@v4
            -
                uses: actions/setup-node@v4
                with:
                    node-version: 20
            -
                uses: actions/setup-go@v5
                with:
                    go-version-file: go.mod
            -
                name: Write dummy config.toml
                run: cp examples/config.example.toml config.toml
            -
                name: Install Node deps
                run: npm i --no-audit --no-fund
            -
                name: Build Tailwind
                run: npm run build
            -
                name: Go mod download
                run: go mod download
            -
                name: Run Go tests
                shell: bash
                run: go test ./tests/... -v -timeout 10m -count=1

    build:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        needs: run-tests
        steps:
            -
                uses: actions/checkout@v4
            -
                name: Setup Node
                uses: actions/setup-node@v4
                with:
                    node-version: 20
            -
                name: Setup Go
                uses: actions/setup-go@v5
                with:
                    go-version-file: go.mod
                    cache: true
            -
                name: Install Node deps
                run: npm i --no-audit --no-fund
            -
                name: Build Tailwind CSS and Webpack assets
                run: npm run build
            -
                name: Prepare build directory
                run: mkdir -p dist
            -
                name: Build Go binary (linux/amd64)
                run: GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w -X main.version=${{ github.sha }}" -o dist/pve-koth .
            -
                name: Bundle runtime assets
                run: |
                    mkdir -p dist/public/static/styles
                    mkdir -p dist/public/views
                    cp -r public/build dist/public/
                    cp -r public/views dist/public/
                    cp README.md dist/
                    cp LICENSE dist/
                    cp go.mod dist/
            -
                name: Create tarball
                run: tar -czf pve-koth-linux-amd64.tar.gz -C dist/ .
            -
                name: Upload artifact
                uses: actions/upload-artifact@v4
                with:
                    name: release-bundle
                    path: pve-koth-linux-amd64.tar.gz

    release:
        runs-on: ubuntu-latest
        needs: build
        steps:
            -
                name: Download artifact
                uses: actions/download-artifact@v4
                with:
                    name: release-bundle
                    path: ./release
            -
                name: Create tag
                run: |
                    TAG="release-${{ github.run_number }}"
                    echo "TAG=$TAG" >> $GITHUB_ENV
                    git tag "$TAG" || true
                    git push origin "$TAG" || true
            -
                name: Publish GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: '${{ env.TAG }}'
                    name: 'Release ${{ env.TAG }}'
                    files: release/**
                    draft: false
                    prerelease: false
                env:
                    GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
                    TAG: '${{ env.TAG }}'
