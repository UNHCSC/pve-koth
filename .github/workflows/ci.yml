name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  ci:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i --no-audit --no-fund

      - name: Build frontend assets
        run: npm run build

      - name: Set up config.toml from examples/config.example.toml
        run: cp examples/config.example.toml config.toml

      - name: Run Go tests
        run: go test ./...

  release:
    name: Build release
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm i --no-audit --no-fund

      - name: Build frontend assets
        run: npm run build

      - name: Build backend
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w -X main.version=release-${{ github.run_number }}" -o dist/koth main.go

      - name: Prepare release tree
        run: |
          rm -rf dist/release
          mkdir -p dist/release/public
          cp README.md LICENSE dist/release/
          cp dist/koth dist/release/
          rsync -a --exclude='static/src' public/ dist/release/public/

      - name: Package release artifact
        run: |
          cd dist/release
          tar -czf ../pve-koth-release.tar.gz -C . README.md LICENSE koth public

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: dist/

      - name: Create Tag
        run: |
          TAG="release-${{ github.run_number }}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          git tag "$TAG" || true
          git push origin "$TAG" || true
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ github.run_number }}
          files: dist/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Create GitHub release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   with:
      #     tag_name: release-${{ github.run_number }}
      #     release_name: Release ${{ github.run_number }}
      #     body: |-
      #       Automated release triggered by merge to main.
      #     draft: false
      #     prerelease: false
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Upload release asset
      #   uses: actions/upload-release-asset@v1
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: dist/pve-koth-release.tar.gz
      #     asset_name: pve-koth-${{ github.run_number }}.tar.gz
      #     asset_content_type: application/gzip
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
